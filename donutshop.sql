Create Database Donut
Go
 
Use Donut
Go

Create Table UserDonut
(
	userid INT IDENTITY(1,1) PRIMARY KEY,
	username  nvarchar(20) NOT NULL unique,
	userpass nvarchar(20) NOT NULL,
	userper int,
)
--donut
Create Table Donut
(
	donutname nvarchar(20) primary key,
	donutimg image,
	donutprice int not null,
	CONSTRAINT namedonut UNIQUE (donutname),
)

Create Table StatusDonut
(
	statusid nvarchar(20) references Donut(donutname) on delete cascade on update cascade,
	donutnumber int check(donutnumber>=0)
)



--vat tu
Create Table Vattu
(
	--vattuid int identity(1,1) primary key,
	vattuten nvarchar(20) not null unique,
	soluong int check(soluong>=0)
)

Create table hoadonnhap
(
	mahoadon nvarchar(20) primary key,
	hduserid nvarchar(20) references userdonut(username) on delete cascade on update cascade,
	ngay Date default getdate(),
)

Create Table cthoadonnhap
(
	idvattu nvarchar(20) references Vattu(vattuten) on delete no action on update cascade,
	mahoadon nvarchar(20) references hoadonnhap(mahoadon) on delete cascade on update cascade,
	soluong int check(soluong>0),
	gia int check(gia>0),
	
)

Create table hoadonban
(
	mahoadon nvarchar(20) primary key,
	hduserid nvarchar(20) references userdonut(username) on delete cascade on update cascade,
	ngay Date default getdate(),
)

Create Table cthoadonban
(
	iddonut nvarchar(20) references Donut(donutname) on delete cascade on update cascade,
	mahoadon nvarchar(20) references hoadonban(mahoadon) on delete cascade on update cascade,
	soluong int check(soluong>0),
	gia int check(gia>0),
	
)
drop table cthoadonban
Create Table CtGioHang
(
	ghuserid int references UserDonut(userid) on delete cascade on update cascade,
	ghdonutid nvarchar(20) references Donut(donutname) on delete cascade on update cascade,
	ghstatus nvarchar(20) check(ghstatus in ('cart','ordering','complete')),
	sl int check(sl>0),
)

Create Table TPdonut
(
	tpdonutid nvarchar(20) references Donut(donutname) on delete cascade on update cascade,
	vattuid nvarchar(20) references Vattu(vattuten) on delete cascade on update cascade ,
	sl float check(sl>0)
)

alter table vattu
add soluong int check(soluong>=0)
--------------========================================================================================================================----------------------------------------------------
--hành vi người dùng
create proc [dbo].[SP_AuthoLogin]
@Username nvarchar(20),																						
@Password nvarchar(20)
as
begin
    if exists (select * from UserDonut where username = @Username and userpass = @Password and userper = 1)
        select 1 as code
    else if exists (select * from UserDonut where username = @Username and userpass = @Password and userper = 2)
        select 2 as code
    else if exists (select * from UserDonut where username = @Username and userpass = @Password and userper = 3)
        select 3 as code
    else select 0 as code
end


--===========================================================================================================
Select donutname,donutimg,donutprice from donut
Insert into Donut values(N'Banana donut','0x89504E470D0A1A0A0000000D4948445200000040000000400806000000AA6971DE000000017352474200AECE1CE90000000467414D410000B18F0BFC6105000011D049444154785EE5D95DB056E57507F05C747A63AE3ABD6BA69336A657994C9DCCA41F17992663629B5A35142B26E08489A61A53751A45EAB7218A18B07C4820C70AE10430F26138780439084A0E0702C811F99423089C231F82F221C6E4C2B0BB7FEB3DEBEDE6B031A0D69B73B166BFFBD97B3FCFFAFFD77FADF5ECFD7EE2925B2E1DD4563B3898AC76703059EDE060B2DAC1C164B58383C96A070793D50E7E54B6B96BF11F57EDC1EB2FFF23E677EFAEAD9FECDDB5FD4FDF7BEFDD0BEA9EFDB8AC76F08318600F7FF78A4F2D7BB2F5AA8E5FCCB8BF6DE6D4F68D2B17B56DEF5EDD91E63CC77A7BBABB8E1CEC7DE9E4F123ED87FAF63CF6FA9E9D63D62F9F7F9F67CDC19E7F6AD63F20A96EBD8FCA6A07CFC79E9D7EF30573C70CBFE4E7131E98F3F4AC693DABDA9E28D6AF5C52BCF2D2DAE250DFABC5E1FDBBE3F792D92DC513931E8AE3C6956DC59EED1B9AD7DF3CB8A738B07747B17B5B77D1B76BFBFF8DBFB1F724920EEDDF7BCBFCB1D7FC0992EB7CF830563B782E2632A204F8E2593FFD2DE03B5E7C3EC0BCF3F681F80DF08C31A3C20007FAD8913DC5C9E307C2DCC77EF3CEA1E2DDDF1C297EF7BB63E5F99120AC6DC6A345C7BC9FC5EF6D1BBA7EBF7CC1EC355445211FA52A6A07DFCFE4EEE1FDBDFFD836EBB1950B7F3AA158D7B1A8D8BB7353F1F6D1030100C0E7E6B514536FBF21AE01FDD6C15DC53B27DE08B0097EA01D3DBCAFD8B86A79D172FFEDA7EE1B39B4681DFFA378D6B524E6F891DE2058DAF0812F753E9E8FD50E9ECD76AD9EF9B95F2D59F4B3852D934F89CEFED7363723C7D14D9D4B22DA73C6DF5BBCBA657D9072A6F5C51121278F1F0AC9AF5838A7987AE7CDC5F89BBF53CC9F3A2EA27EE2CDD7634EF723CE1A0C09486E5C2FEB47991E1F4611B58303AD288A0B14A917163F799034C99B73C093AF48917BCBBD3F88A88B66C3F9869D78AB6109DCEF97D7AE8A288FBD6144809742EA0052443B09320FC0C7DF7A2D8830F7D6B5CBE279A9E1488DF77CEB9FAE1EF3AD2F7FE17CEB44ED60D5B429557AD5D30B2227DFE8DDD104CE318E937BDBCCE951BC38FEF6B1430DF08EFD068C23A7C9FCAE6FFE7310060C50E6CB14A93E1F649466EED7B6AC29A41DA5FCF0BA6F06E908E7971A234014BA6D75FBA7EBB0D459ED609A1C13790B90A95C4E473943EA331EBC3B249B912651804834AC3FFA80BB77D4955F0F003A817BB30026A955E5200D70247B76E26DDF6F2A664DFBDCF29E329D4A92AC832473384A8D734D8BDAC134F9A5C223E0C8819E70EEE81BBB8BCEB69F8713486914A5FE88F55B82E69C022952B70DB9389CF7ECA17D5BFBA3DC17D23E71B437E676F49CF98E1EEE8B764A25778D1812664D63086EA4882ED2009DCAF31CD2A8F65C48A81D647B5ED93262EE941F9F202DE039A7B03D39694C5814392002483FE0FEA8A564A5858ACE96CFFD49D40A2964BE504A49E6817D9BC20EEFDFD61C57181543A01197C01B6437D2244DF4D5012A519C1561B545D0B44E9BA9F7AB0BB58372A865CC9DBB4D44F6C0CB35933B86E4FA8B1402801795504079AE9D917946BCAF676300D7357A7BD60760F33AEE7B656D8C5385CD0F30A47ECB655F29AEFFDADF877A14C7504B490EB37EA607D05251614630C521AAA1867D45DFEE9DC728D9F6BB0EEB19036CC2B55F1DA750714C94F47511C9BE9C52CF883324D8C9214D8173BFE791670E0081DDBBBDAB19F5DD5B7E1563C8011EB9D402F8F0BFFB7CCC91E451073397B572CFF0F48CFF6EAE630E4AA13CC4F105415D4B179DB269ABC37AC6807692E039690104C40EAF3FEFAAE0C99D64B547CE4FFAC17551E044B80ADA51F4D376BED851EC58BFB4E8796965104BB288037ED8173E1B6986200434D4D14811E6DEEC20E143E9572A87F25CE3734F77E7298A90AEDD9DCF6D950E03F19E76A28FCE1877EFEB1E20A9A5AD53222A6457CDBB5C14703562FC8D230238B98B9668707AF7A695C52B6B17175B3A9F0A031870BFBB9F7BA27869E5FC3060491E81577CEECF23E7B774B50739484098F9CC8D689217203E5083162DDD80267BC132EE7AD3CA4079AF1858189B3F140AFB7AEC022E8A1605A66965EE89BCDCD301A225957B00F78A8C6BC8F25BC4119080373C3BA758D3D652AC5E3025CC6FA6AE88FA8C7BFE2364AFE8ADFAE5CC2006099E4F12809FFDF01DA14C81E007990B805DA8B1DC360B52B3489796E7B6D0B5042C7C68F85FCD9F3EA137732AFB3DE04025B314416A8067C463F212BC8D9173CE92BDBD421D012B5AC786011DE0EF18192044DF986BEEA512CF5282E8022F25B44ED2A614041ACB961A0494118F5A216015121AC41C69AF16C426018A0439BFFE5A7700AF6E4C00CC0227C7A8044948B148F65E4EC967C0993412C5040F58FBF4FB8AB609FF19A0FFFDCB171593AFFB4A3167F495F19BF9FDD403C3E33E64799622B32600294581172CA4F3959FF99B02F9910591DF8A22D5DA905555D024C0C70845A5D98FFBF7DEA29F72CF5D9F316A408A0A9B7B03263F152135216BC3E29687033CE0008E1DF6C5E2A6BFF9B3E2EEAF7EA6987AE585C5C42BFEB279EEB731F72D6B191D44505BFA667DE029823AF928B2800B827AA088677A5A9B6AA5A9BD8234F25AEDFB42930092F0A5A6DAA22CA6FF0264B2C60EAC2FC61234F95940FE65912247CEDAAA8A9CCAAEC089780267804E1F76615892E098F6D8F0CF060948438234D8BA6E45803337F0A21E72EFDF357A4FE02FDF00D6161543CAD425DCA37D22C477852601363E3BBA3BF764B1216F06A0689AC044803B978B9C0056BB93FF8D546928263A4039974226F2806B6D721C78A0016455121278DACC6B2F8A743087B9AC2B25AAE0A990BC154E6B53035F9102F44FEEBAB5A1DE120B6290646FE00DD2D7AC20407FC42EA719F06E2435B21275E7C06356A419F016656A8105B352B73E382A22F7CCE45B0388086794ABE01338CBEB55523C6B0E732ABAF21C01EA8FD4E423F0C6F941BD02152F4ED70E0DD0B0C140118CEF022EF0CDFC57348057BC4CAC277B50C1212B396712A04DA04E44AD2817CD0229DFDD17C5AFACDE1C6FBDE96B01A20ABA6A5502AA96D71CA50FF0599B0448D481E36F2A4F2A8AB8B4730DA6084E28625F13BC790EEDD9B2330820035F69C9590D90BFDEB5750404908E895376DA8D16C314426C2B76B960A682EB3641CFFCE8E2F72560F2559F796FF2B00BDF744CC02C894020D923DEBCD61090AC03DA1E3FF82B68DA28BF29320D09E96FAAB749809D914FD4B9652535D55E3BB490569345117321C1687DFB9ABB40CE6037DB62EE1439B87BE3B262C9A4914DF04904D0E387FE45C78F877CFA563B505B70BF8DB9F63F37FC6D28C8660A00CE2B62889686C850F9758594BB54E0A3B5D5255625807FE6A1E40A015B3F990400A2606090E4F47C7D3CB7A2498289E4BAEBF6DB161221968B480BA9C4E16C83002DB8E7F277BD6C01AD15E940CC7F0A3EAFABCE5D0B1EDD6F03653E05D83C82619E541959DB8F88BAA019CF00F027BB033F547E4AD522ED0B0478E1A3637B9A044801F92F8701C3704616786A48F09CD24F2D2CD72DA417732AFA70794DABE294368820ECBB2E1288C43ED2ADAB278FBBF19A151C72AF35008817ACD259BDFCC90977476A7A5E9517413547D4050AE1C0B3887A490ED00AA42F508CBF02663E057AD1A377BF2C00F10E600F60220FC87737296680B34C014080F6A182FCA543B05D3AA558026E11C4359D2A9FE1B8FB32321CD4314482E27C2C414CAA47A47213A3C821DDB322EA9A3580704DC4D3CC9DE4C48794720E69813CE4BA9F5260F4270ED535BB80C548CA3BB8C8E586A84A0227E59B76E8B76801070C20F90D40B413309290E0776EA9018F4A5D463641B84E41DAAD428668737B269FCB9E8E606401ECB938967B7D5157C0455B40153B8432354A90740F01A4BAE63E604BFB03DF93A326E600D957C1335D22F60625AB58CC94502F2C68E270AA5403879090A673880C49032EBDA419C7A8C1FD414CD971A48EB59A0A2A4DFE0286F8460D68BC7C65B1952EA24EEAA98C287AA59947A1B4F901DCAED41AEB7F71E744D89B1BA1E533EF3F498A24A320A62123B7B7265089B315021FBBAC32A2006624D33106A067C81651D44525A2EB5A464EFDD171442D5301298059D773A298EAB2869450205D570F04D0F352C6F31425555D473C6569A9BE4B087A9300AD5051583DF7FED872C68788B2FD688B0C09AA39008A25599368D5698002543F09C0733825E7BEACD4099024B39BE446C7F399EB51B8FAD562EE06F0C6DC9ECD4D8FF4152CC0D304C4DADE30636F50063076BA25AE9EAE0507FDCBD5244021EC9C7DC7DC0D6D8F9C7AB9A3DCC9F57FB94912140DF212059300CF39394F09B9494AB98B0E07D50BE04526DEC94B0000BA267248E1BCB5627F51CE8334A962BD6A7B6B806F7C7BCC94486055E0099E727C60718F94A03A58EC4B14FDFC261004B015D3467EE7D70B1E2A5E5EF648B16DE5ACD8C5E5373B12B7607EA2D293116071CCAB11D9258020E9885E19D9D895954E8B20205968CD8330DF1CF2E34B35AAD291D300214DD429432E937B760E4A720FF5B02A780A15440A667EC396F23F8D005F8456B7DEFC2A02BA9F79A0A004FB791B2160440B586A70AE4D029169A24E289CF6010A8D966A1313B5A02C8C220B3870D22C8BAB679027AAD49292070E30C4795E3E0B84EB7C72AD0ABC0ADE9B27920490CF297D41DDF4D4A8BD36406710C0A820D22049288FBEE428749C32915A80596AC8FA003C6B82EFEF141939E039661EEFE29EE1585A748712BCB6981D00B87C5E95A70CF302426955E04C1DA20E914F9243F215F0F064F54F3B8D0079A1162478475F65B416ACE70E51A7C8C8032392AE014FF6C00341F29CCFC8656FCF2228625421DF491A10D7F27D43DE531135F1015955D054C2CCA368FABEC807953E8097F9CE12BCE867F14B3B8D00F6F4F8CB2F920A49C20B336EF8BDD7511F2839A9570342014C8191E7D16A4AF35B3438C8798550FD502F806348408088012F9D44D538E08E2C0B692AA30A9A215E00B248ABF87C147185358097A9BCF997B78555733FEDB493B475736EBA185B1B168D293A678F8AAF32EB17DE136A88F77D7DB45484233244C8E25A9928718A0A8C6744389CC44809FDD97655673196B24F039E9A54714AF3AC3910E11C786B591F49BE36210A68B54BB113C4CDF3AE2D362FB8B1D8BAF8BF9ECDEF80553BEDA46ACB265F35040908001C01EBE67EAF5023009263484088BC23D15406F9E9C1C6B5390E735C556729576D0E10E0AA969157C800F26CB56E887048BC34BB53454F5DA252AA8D8897A0137C9DF4D3CE18A89AA2280518222802116B5AAF2FB44C445898FCFC4608A9AB1114A168394F52225DCA73F72B54EECF5A92CAF1D24239C0031460071879539F828A4873F1278003DD0F3CC153741D3E563B98A628BED0F2ED4908001A78B27A71EEC8A2EBF111511FC85824F3AF2E47399FD20732D385E30A2265642AE57882B2DF37A7EEE39C02061A895B8B4A44BF63F255C5BAD66F3780F7E73B7B71DEADA7EAF2BE6AB5835593370349900ACCC2B75FF6D751232844147C08157D476424318C32448C329CC73EA3623658F96C3EE379F9AC98A559C757A6E8F7C3BE18E00525A25E01AFE5E58EEF6C563B38D0BC363E3BE5EA0793842480131C40C4AA69FF1AE653966F802BA65D13A4B8DFD17B46FE1BE4CD336A49C58C21D37F01996A40B058B30449752CD751F8968EFBFA19047846D0F85D87A76AB58375E67DA163CAD5A35F68B9E66D4E700A01FEDA4A627EDD7A75316FF497E24368E7D44BC29E1FFFA5A6F9E7076149D69AC7AF0C5BFD58E339C4AD7DFCB21873AC336B781659CCBAC03341593FE7FBBF3D57F0AC76F06C8604DDA163E2D0C58810E52400EBA18C321A098CC3490452100068153C730EBC683A073241F95D35F367EA514BAE2928F62F0AF71F927DD56A07FF90611711CB260D5D17FFDC9444884455AA03010227FA88705E05B562E2A5418C7B53CE03CD781A0210EF396B3D3F6DD8A9A5132E9BE37DA6CEDFF7B3DAC1733505525A2C9B38A417099C8948949206D231CF392B6F1151BD960425290309C808B39CD75C52CA511044FD5C253FD06A07CFD7302FEF10211A8CB35502380E3C05709C2570264DF27E662CCFFD36673E671D11A7C2BADDDDF958EDE00735EF11A188322ACF4DFDB763E174A98C34E7E49B40D28C57C948336E1EF301DCFEF0BF8C061AE1EA9135F3F841AD76F0C39AA82023A459B6CF88560942E4963CF28D9303CD7858798F025B056B1EF37D58A067B3DAC18FC2385C8D5292E2DF9F3CE66FE61BFDFF27D0B359EDE0C7691F37E081563B3898AC76703059EDE060B2DAC1C163977EE27F014F6CE8D4692128A50000000049454E44AE426082','150')
update donut set donutprice='120' where donutname='Banana donut'
delete donut where donutname='Apple donut'
--==============
select statusid,donutnumber from StatusDonut
Insert into StatusDonut values(N'Apple donut','5'),(N'Banana donut','5')
update StatusDonut set donutnumber=donutnumber+1 where statusid='Apple donut'
delete StatusDonut where statusid='Banana donut'
--=============
Select userid,username,userpass,userper from userdonut
Insert into UserDonut(username,userpass,userper) values('admin','admin','1'),
														('beft','admin','2'),
														('guest','admin','3')
update userdonut set userper='1' where userid='1'
Delete Userdonut where userid='1'
--==============
select vattuten,soluong from vattu
Insert into vattu values(N'sugar'),(N'pan'),(N'table'),(N'salt'),(N'chocolate')
delete vattu where vattuten='table'
update vattu set soluong='10' where vattuten='sugar'
--==============
select mahoadon,hduserid,ngay from hoadonnhap
Insert into hoadonnhap values('hd004','beft','2023-27-04')
delete hoadonnhap where mahoadon='hd003'
--==============
select mahoadon,hduserid,ngay from hoadonban
Insert into hoadonban values('guest-26/04/2023','guest','2023-04-26')
delete hoadonnhap where mahoadon='guest-26/04/2023'
--==============
select iddonut,mahoadon,soluong,gia from cthoadonban
Insert into cthoadonban values(N'Banana donut','guest-26/04/2023','3','10')
delete cthoadonban where mahoadon='guest-26/04/2023' and iddonut='Apple donut'
--==============
select idvattu,mahoadon,soluong,gia from cthoadonnhap
Insert into cthoadonnhap values(N'salt','hd003','3','10')
delete cthoadonnhap where mahoadon='hd002' and idvattu='sugar'
--==============
select ghdonutid,ghstatus,sl from CtGioHang where ghuserid='3'
Insert into CtGioHang values('3','Apple donut','cart','3')
delete CtGioHang where ghdonutid='Apple donut' and ghuserid='3'
--==============
select TPdonutid,vattuid,sl from TPdonut
Insert into TPdonut values('Apple donut','salt','2'),('Apple donut','sugar','2')
delete TPdonut where tpdonutid='Apple donut' and vattuid='salt'
--==============
select mahoadon,hduserid,ngay from
(select mahoadon,hduserid,ngay from hoadonban union all select mahoadon,hduserid,ngay from hoadonnhap) as nhap 
where hduserid='guest' or mahoadon='hd001'


Set xact_abort on
begin tran

declare @ten nvarchar(20)
declare @sl int
declare tro cursor
for (select vattuid,sl from TPdonut where tpdonutid=N'Apple donut')
open tro
fetch next from tro into @ten,@sl
while @@FETCH_STATUS=0
begin
	update vattu set soluong=soluong-@sl where vattuten=@ten
	fetch next from tro into @ten,@sl
end
close tro
deallocate tro

commit

select iddonut as id,mahoadon,soluong,gia from
(select iddonut,mahoadon,soluong,gia  from cthoadonban union all select idvattu,mahoadon,soluong,gia  from cthoadonnhap) as nhap 
where mahoadon='hd002'

select Month(ngay) as thang,sum(soluong*gia) as tong from hoadonban inner join cthoadonban on hoadonban.mahoadon=cthoadonban.mahoadon
group by Month(ngay)

select Month(ngay) as thang,sum(soluong*gia) as tong from hoadonnhap inner join cthoadonnhap on hoadonnhap.mahoadon=cthoadonnhap.mahoadon
group by Month(ngay)

select Day(ngay) as ngay,sum(soluong*gia) as tong from hoadonban inner join cthoadonban on hoadonban.mahoadon=cthoadonban.mahoadon
where Month(ngay)='6'
group by Day(ngay)

select Day(ngay) as ngay,sum(soluong*gia) as tong from hoadonnhap inner join cthoadonnhap on hoadonnhap.mahoadon=cthoadonnhap.mahoadon
where Month(ngay)='6'
group by Day(ngay)

select Day(ngay) as ngay,sum(soluong*gia) as tong from hoadonnhap inner join cthoadonnhap on hoadonnhap.mahoadon=cthoadonnhap.mahoadon
                            where Month(ngay)= 29
                            group by Day(ngay)

select donutnumber from statusdonut where statusid='Apple donut'

